<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catequese - Controle de Turmas e Faltas</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#f5f5f5; }
.topbar { background:#3f51b5; color:white; padding:10px; display:flex; align-items:center; gap:10px; }
.brand { height:40px; }
.container { padding:20px; max-width:900px; margin:auto; }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
button { padding:5px 10px; cursor:pointer; border:none; border-radius:4px; color:white; }
button.presenca { background:green; }
button.falta { background:red; }
ul { list-style:none; padding:0; }
li { padding:5px 0; display:flex; justify-content:space-between; align-items:center; }
li span { cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ccc; padding:5px; text-align:left; }
.alert { padding:5px; margin-bottom:5px; border-radius:4px; }
.warn { background:#ffcccc; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<header class="topbar">
  <img src="assets/brand.png" alt="Identidade" class="brand" />
  <h1>Catequese de Crisma</h1>
</header>

<main class="container">
  <section id="app">
    <div class="card">
      <h2>Painel</h2>
      <div class="row">
        <button id="btnNewTurma">Criar Turma</button>
        <button id="btnNewAluno">Adicionar Aluno</button>
        <button id="btnNovoEncontro">Criar Encontro</button>
        <button id="btnRelatorio">Relatórios (CSV)</button>
      </div>
      <div id="alerts"></div>
    </div>

    <div class="card">
      <h3>Suas Turmas</h3>
      <ul id="turmaList"></ul>
    </div>

    <div class="card" id="turmaView" style="display:none;">
      <h3 id="turmaTitle"></h3>
      <div id="encontrosArea"></div>
      <h4>Alunos</h4>
      <table id="alunosTable">
        <thead><tr><th>Nome</th><th>Presenças</th><th>Faltas</th><th>Ações</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
const firebaseConfig = {
  apiKey: "PASTE_API_KEY",
  authDomain: "PASTE_AUTH_DOMAIN",
  projectId: "PASTE_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const senha = "212121";
const $ = id => document.getElementById(id);

const turmaList = $('turmaList');
const turmaView = $('turmaView');
const turmaTitle = $('turmaTitle');
const encontrosArea = $('encontrosArea');
const alunosTableBody = $('alunosTable').querySelector('tbody');
const alertsDiv = $('alerts');

let currentTurmaId = null;

// Criar turma
$('btnNewTurma').addEventListener('click', async () => {
  const s = prompt('Senha:');
  if(s!==senha){ alert('Senha incorreta!'); return; }
  const nome = prompt('Nome da turma');
  if(!nome) return;
  await db.collection('turmas').add({ nome, createdAt:new Date().toISOString() });
});

// Adicionar aluno
$('btnNewAluno').addEventListener('click', async () => {
  if(!currentTurmaId){ alert('Abra uma turma'); return; }
  const s = prompt('Senha:');
  if(s!==senha){ alert('Senha incorreta!'); return; }
  const nome = prompt('Nome do aluno');
  if(!nome) return;
  await db.collection('alunos').add({
    nome, turmaId: currentTurmaId, presencas:0, faltas:0, createdAt:new Date().toISOString()
  });
});

// Criar encontro
$('btnNovoEncontro').addEventListener('click', async () => {
  if(!currentTurmaId){ alert('Abra uma turma'); return; }
  const data = prompt('Data do encontro (DD/MM/AAAA)');
  if(!data) return;
  const parts = data.split('/');
  const iso = new Date(parts[2], parts[1]-1, parts[0]).toISOString();
  await db.collection('encontros').add({ turmaId: currentTurmaId, dataISO: iso, createdAt:new Date().toISOString() });
});

// Abrir turma
function openTurma(tid){
  currentTurmaId = tid;
  turmaView.style.display='block';

  db.collection('turmas').doc(tid).onSnapshot(tdoc => {
    turmaTitle.textContent = tdoc.data().nome;
  });

  db.collection('encontros').where('turmaId','==',tid).orderBy('dataISO','desc').onSnapshot(snap=>{
    encontrosArea.innerHTML='';
    snap.forEach(e=>{
      const d = new Date(e.data().dataISO);
      const div = document.createElement('div');
      div.innerHTML=`<strong>${d.toLocaleDateString()}</strong> <button data-id="${e.id}" class="markBtn">Marcar presença</button>`;
      encontrosArea.appendChild(div);
    });
    [...document.querySelectorAll('.markBtn')].forEach(b=>{
      b.onclick=()=>markPresenca(b.dataset.id);
    });
  });

  db.collection('alunos').where('turmaId','==',tid).orderBy('nome').onSnapshot(snap=>{
    alunosTableBody.innerHTML='';
    snap.forEach(doc=>{
      const a = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML=`<td>${a.nome}</td>
                    <td>${a.presencas}</td>
                    <td>${a.faltas}</td>
                    <td>
                      <button class="presenca" onclick="marcarPresencaAluno('${doc.id}')">Presença</button>
                      <button class="falta" onclick="marcarFaltaAluno('${doc.id}')">Falta</button>
                      <button onclick="removerAluno('${doc.id}')">Excluir</button>
                    </td>`;
      alunosTableBody.appendChild(tr);
    });
  });
}

// Funções de presença/falta
async function marcarPresencaAluno(id){
  const doc = await db.collection('alunos').doc(id).get();
  const pres = (doc.data().presencas||0)+1;
  await db.collection('alunos').doc(id).update({ presencas: pres });
}

async function marcarFaltaAluno(id){
  const doc = await db.collection('alunos').doc(id).get();
  const faltas = (doc.data().faltas||0)+1;
  await db.collection('alunos').doc(id).update({ faltas: faltas });
  if(faltas>=5) alert(`Atenção! O aluno ${doc.data().nome} atingiu 5 faltas.`);
}

async function removerAluno(id){
  const s = prompt('Senha:');
  if(s!==senha){ alert('Senha incorreta!'); return; }
  await db.collection('alunos').doc(id).delete();
}

// Listar turmas
db.collection('turmas').orderBy('createdAt','desc').onSnapshot(snap=>{
  turmaList.innerHTML='';
  snap.forEach(doc=>{
    const li = document.createElement('li');
    li.innerHTML=`<span data-id="${doc.id}">${doc.data().nome}</span>
                  <button data-id="${doc.id}" class="delTurmaBtn">Excluir</button>`;
    turmaList.appendChild(li);
  });
  [...document.querySelectorAll('#turmaList span')].forEach(span=>{
    span.onclick=()=>openTurma(span.dataset.id);
  });
  [...document.querySelectorAll('.delTurmaBtn')].forEach(btn=>{
    btn.onclick=async ()=>{
      const s = prompt('Senha:');
      if(s!==senha){ alert('Senha incorreta!'); return; }
      await db.collection('turmas').doc(btn.dataset.id).delete();
    };
  });
});

// Marcar presença geral (por encontro)
async function markPresenca(encontroId){
  const alSnap = await db.collection('alunos').where('turmaId','==',currentTurmaId).get();
  for(const a of alSnap.docs){
    const nome = a.data().nome;
    const r = prompt(`Status para ${nome} (P/F/J). Deixe em branco para P.`,'P');
    const status = r? r.toUpperCase():'P';
    await db.collection('presencas').add({ alunoId:a.id, encontroId, status, createdAt:new Date().toISOString() });
  }
  alert('Presenças registradas.');
}
</script>
</body>
</html>
