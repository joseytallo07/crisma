<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catequese - Controle de Turmas e Faltas</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
    header { background:#6200ea; color:#fff; padding:10px; text-align:center; }
    .container { max-width:900px; margin:20px auto; padding:10px; }
    .card { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#6200ea; color:#fff; cursor:pointer; }
    button:hover { background:#4500a0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#eee; }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Catequese de Crisma</h1>
  </header>

  <main class="container">
    <section id="app">
      <div class="card">
        <h2>Painel</h2>
        <button id="btnNewTurma">Criar Turma</button>
        <button id="btnNewAluno">Adicionar Aluno</button>
      </div>

      <div class="card">
        <h3>Suas Turmas</h3>
        <ul id="turmaList"></ul>
      </div>

      <div class="card" id="turmaView" style="display:none;">
        <h3 id="turmaTitle"></h3>
        <button id="btnVoltar">Voltar</button>
        <h4>Alunos</h4>
        <table>
          <thead>
            <tr><th>Nome</th><th>Faltas</th><th>Ações</th></tr>
          </thead>
          <tbody id="alunosTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC4GsCM_rU8Z7MwCMNvLFtZKB5wFdIxQXo",
      authDomain: "web-crisma.firebaseapp.com",
      projectId: "web-crisma",
      storageBucket: "web-crisma.appspot.com",
      messagingSenderId: "153889070231",
      appId: "1:153889070231:web:687e04924a9e05cae51dd2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const turmaList = document.getElementById("turmaList");
    const turmaView = document.getElementById("turmaView");
    const turmaTitle = document.getElementById("turmaTitle");
    const alunosTable = document.getElementById("alunosTable");

    let turmaSelecionada = null;

    // Criar turma
    document.getElementById("btnNewTurma").onclick = async () => {
      const senha = prompt("Digite a senha:");
      if (senha !== "212121") return alert("Senha incorreta.");
      const nome = prompt("Nome da Turma:");
      if (nome) {
        await db.collection("turmas").add({ nome });
      }
    };

    // Criar aluno
    document.getElementById("btnNewAluno").onclick = async () => {
      if (!turmaSelecionada) return alert("Selecione uma turma antes.");
      const senha = prompt("Digite a senha:");
      if (senha !== "212121") return alert("Senha incorreta.");
      const nome = prompt("Nome do Aluno:");
      if (nome) {
        await db.collection("alunos").add({
          nome,
          faltas: 0,
          turmaId: turmaSelecionada.id
        });
      }
    };

    // Voltar
    document.getElementById("btnVoltar").onclick = () => {
      turmaSelecionada = null;
      turmaView.style.display = "none";
    };

    // Listar turmas em tempo real
    db.collection("turmas").onSnapshot(snapshot => {
      turmaList.innerHTML = "";
      snapshot.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = doc.data().nome;
        li.style.cursor = "pointer";
        li.onclick = () => abrirTurma(doc.id, doc.data().nome);
        turmaList.appendChild(li);
      });
    });

    // Abrir turma
    function abrirTurma(id, nome) {
      turmaSelecionada = { id, nome };
      turmaTitle.textContent = "Turma: " + nome;
      turmaView.style.display = "block";

      db.collection("alunos")
        .where("turmaId", "==", id)
        .onSnapshot(snapshot => {
          alunosTable.innerHTML = "";
          snapshot.forEach(doc => {
            const aluno = doc.data();
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${aluno.nome}</td>
              <td>${aluno.faltas}</td>
              <td>
                <button onclick="marcarPresenca('${doc.id}', ${aluno.faltas})">Presença</button>
                <button onclick="marcarFalta('${doc.id}', ${aluno.faltas})">Falta</button>
                <button onclick="removerAluno('${doc.id}')">Remover</button>
              </td>
            `;
            alunosTable.appendChild(tr);
          });
        });
    }

    // Funções para alunos
    async function marcarPresenca(id, faltas) {
      await db.collection("alunos").doc(id).update({ faltas: Math.max(0, faltas - 1) });
    }

    async function marcarFalta(id, faltas) {
      await db.collection("alunos").doc(id).update({ faltas: faltas + 1 });
    }

    async function removerAluno(id) {
      const senha = prompt("Digite a senha:");
      if (senha !== "212121") return alert("Senha incorreta.");
      await db.collection("alunos").doc(id).delete();
    }
  </script>
</body>
</html>
