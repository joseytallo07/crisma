<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catequese - Controle de Turmas e Faltas</title>
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#f5f5f5; }
.topbar { background:#3f51b5; color:white; padding:10px; display:flex; align-items:center; gap:10px; }
.container { padding:20px; max-width:900px; margin:auto; }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
button { padding:5px 10px; cursor:pointer; border:none; border-radius:4px; background:#3f51b5; color:white; }
ul { list-style:none; padding:0; }
li { padding:5px 0; display:flex; justify-content:space-between; align-items:center; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ccc; padding:5px; text-align:left; }
.alert { padding:5px; margin-bottom:5px; border-radius:4px; }
.warn { background:#ffcccc; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<header class="topbar">
  <h1>Catequese de Crisma</h1>
</header>

<main class="container">
  <section id="app">
    <div class="card">
      <h2>Painel</h2>
      <div class="row">
        <button id="btnNewTurma">Criar Turma</button>
        <button id="btnNewAluno">Adicionar Crismando</button>
        <button id="btnNovoEncontro">Registrar Encontro</button>
        <button id="btnRelatorio">Relatórios (CSV)</button>
      </div>
      <div id="alerts"></div>
    </div>

    <div class="card">
      <h3>Turmas</h3>
      <ul id="turmaList"></ul>
    </div>

    <div class="card" id="turmaView" style="display:none;">
      <h3 id="turmaTitle"></h3>
      <div id="encontrosArea"></div>
      <h4>Crismandos</h4>
      <table id="alunosTable">
        <thead><tr><th>Nome</th><th>Faltas</th><th>Ações</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
// === FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyC4GsCM_rU8Z7MwCMNvLFtZKB5wFdIxQo",
  authDomain: "web-crisma.firebaseapp.com",
  projectId: "web-crisma",
  storageBucket: "web-crisma.firebasestorage.app",
  messagingSenderId: "153889070231",
  appId: "1:153889070231:web:687e04924a9e05cae51dd2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// === VARIÁVEIS ===
const senha = "212121";
const $ = id => document.getElementById(id);
const turmaList = $('turmaList');
const turmaView = $('turmaView');
const turmaTitle = $('turmaTitle');
const encontrosArea = $('encontrosArea');
const alunosTableBody = $('alunosTable').querySelector('tbody');
const alertsDiv = $('alerts');
let currentTurmaId = null;

// === CRIAR TURMA ===
$('btnNewTurma').onclick = async () => {
  const s = prompt('Senha para criar turma:');
  if(s !== senha){ alert('Senha incorreta'); return; }
  const nome = prompt('Nome da turma');
  if(!nome) return;
  await db.collection('turmas').add({nome, createdAt: new Date().toISOString()});
};

// === ADICIONAR ALUNO ===
$('btnNewAluno').onclick = async () => {
  if(!currentTurmaId){ alert('Abra uma turma'); return; }
  const s = prompt('Senha para adicionar aluno:');
  if(s !== senha){ alert('Senha incorreta'); return; }
  const nome = prompt('Nome do aluno');
  if(!nome) return;
  const resp = prompt('Responsável (opcional)') || '';
  await db.collection('alunos').add({nome, responsavel: resp, turmaId: currentTurmaId, createdAt: new Date().toISOString()});
};

// === CRIAR ENCONTRO ===
$('btnNovoEncontro').onclick = async () => {
  if(!currentTurmaId){ alert('Abra uma turma'); return; }
  const data = prompt('Data do encontro (DD/MM/AAAA)');
  if(!data) return;
  const parts = data.split('/');
  const iso = new Date(parts[2], parts[1]-1, parts[0]).toISOString();
  await db.collection('encontros').add({turmaId: currentTurmaId, dataISO: iso, createdAt: new Date().toISOString()});
};

// === ABRIR TURMA ===
function openTurma(tid){
  currentTurmaId = tid;
  turmaView.style.display='block';

  // Informações da turma
  db.collection('turmas').doc(tid).onSnapshot(tdoc => {
    turmaTitle.textContent = tdoc.data().nome;
  });

  // Encontros
  db.collection('encontros').where('turmaId','==',tid).orderBy('dataISO','desc').onSnapshot(snap => {
    encontrosArea.innerHTML='';
    snap.forEach(ed => {
      const d = new Date(ed.data().dataISO);
      const div = document.createElement('div');
      div.innerHTML = `<strong>${d.toLocaleDateString()}</strong> <button data-id="${ed.id}" class="markBtn">Marcar presença</button>`;
      encontrosArea.appendChild(div);
    });
    [...document.querySelectorAll('.markBtn')].forEach(b => b.onclick = () => markPresenca(b.dataset.id));
  });

  // Alunos
  db.collection('alunos').where('turmaId','==',tid).orderBy('nome').onSnapshot(snap => {
    alunosTableBody.innerHTML='';
    snap.forEach(a => {
      const data = a.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${data.nome}</td><td class="faltasCell" data-id="${a.id}">0</td><td><button data-id="${a.id}" class="delAlunoBtn">Excluir</button></td>`;
      alunosTableBody.appendChild(tr);
    });

    // Excluir aluno
    [...document.querySelectorAll('.delAlunoBtn')].forEach(b => {
      b.onclick = async () => {
        const s = prompt('Senha para excluir aluno:');
        if(s !== senha){ alert('Senha incorreta'); return; }
        await db.collection('alunos').doc(b.dataset.id).delete();
      };
    });

    // Faltas e alertas
    snap.forEach(a => {
      const alunoId = a.id;
      db.collection('presencas').where('alunoId','==',alunoId).where('status','==','F').onSnapshot(presSnap => {
        const faltas = presSnap.size;
        const cell = document.querySelector(`.faltasCell[data-id='${alunoId}']`);
        if(cell) cell.textContent = faltas;
        let div = alertsDiv.querySelector(`.alert[data-id='${alunoId}']`);
        if(faltas >= 4){
          if(!div){ div=document.createElement('div'); div.className='alert warn'; div.dataset.id=alunoId; alertsDiv.appendChild(div);}
          div.innerHTML = `<strong>Atenção:</strong> ${a.data().nome} tem ${faltas} faltas.`;
        } else if(div){ div.remove(); }
      });
    });
  });
}

// === MARCAR PRESENÇA ===
async function markPresenca(encontroId){
  const alSnap = await db.collection('alunos').where('turmaId','==',currentTurmaId).orderBy('nome').get();
  for(const a of alSnap.docs){
    const nome = a.data().nome;
    const r = prompt(`Status para ${nome} (P/F/J). Deixe em branco para P.`, 'P');
    const status = r? r.toUpperCase() : 'P';
    await db.collection('presencas').add({encontroId, alunoId:a.id, status, createdAt:new Date().toISOString()});
  }
  alert('Presenças registradas.');
}

// === EXCLUIR TURMA ===
async function excluirTurma(tid){
  const s = prompt('Senha para excluir turma:');
  if(s !== senha){ alert('Senha incorreta'); return; }
  await db.collection('turmas').doc(tid).delete();
  turmaView.style.display='none';
}

// === LISTAR TURMAS EM TEMPO REAL ===
db.collection('turmas').orderBy('createdAt','desc').onSnapshot(snap => {
  turmaList.innerHTML='';
  snap.forEach(doc => {
    const t = doc.data();
    const li = document.createElement('li');
    li.innerHTML = `<strong>${t.nome}</strong>
      <div>
        <button data-id="${doc.id}">Abrir</button>
        <button data-id="${doc.id}">Excluir</button>
      </div>`;
    turmaList.appendChild(li);
  });

  // Adicionar eventos
  turmaList.querySelectorAll('button').forEach(b => {
    b.onclick = () => {
      if(b.textContent === 'Abrir') openTurma(b.dataset.id);
      else if(b.textContent === 'Excluir') excluirTurma(b.dataset.id);
    };
  });
});
</script>

</body>
</html>
